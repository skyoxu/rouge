# Task 10 Context: RngService

- GeneratedAt: 2026-01-11 16:10:56
- Branch: task/T10
- Source: Serena MCP symbol/search outputs + repository files (reference snapshot)

## 1) Task Mapping (master/tasks.json)

- id: `10`
- title: `创建随机数服务 (RngService)`
- priority: `high`  complexity: `4`  status: `pending`
- dependencies: `[]`
- adrRefs: `['ADR-0011', 'ADR-0018', 'ADR-0021', 'ADR-0024']`
- archRefs: `['CH01', 'CH06', 'CH07', 'CH10']`
- overlay: `docs/architecture/overlays/PRD-rouge-manager/08/08-Feature-Slice-Minimum-Playable-Loop.md`

### details
```text
创建 Game.Core/Services/RngService.cs:
- 字段: System.Random _rng
- 方法:
  - SetSeed(seed): 固定种子(用于调试/回放/测试)
  - NextInt(min, max): 返回 [min, max) 随机整数
  - NextFloat(): 返回 [0, 1) 随机浮点数
  - Shuffle<T>(List<T>): Fisher-Yates 洗牌算法
  - PickRandom<T>(List<T>): 随机选择一个元素
- 设计为接口 IRngService,便于测试时 Mock。
- 在 GameState 中记录 RunSeed,启动时调用 SetSeed(RunSeed)。
Overlays: docs/architecture/overlays/PRD-rouge-manager/08/_index.md; docs/architecture/overlays/PRD-rouge-manager/08/08-Feature-Slice-Minimum-Playable-Loop.md; docs/architecture/overlays/PRD-rouge-manager/08/08-Contracts-Rouge-Run-Events.md; docs/architecture/overlays/PRD-rouge-manager/08/08-Contracts-Security.md; docs/architecture/overlays/PRD-rouge-manager/08/08-Contracts-Quality-Metrics.md; docs/architecture/overlays/PRD-rouge-manager/08/ACCEPTANCE_CHECKLIST.md
```

### testStrategy
```text
xUnit 单元测试:
- RngServiceTests: 固定 Seed 验证可复现性(多次调用返回相同序列)
- Shuffle 测试: 固定 Seed 洗牌结果一致
- 边界测试: min >= max 抛异常、空列表 PickRandom 抛异常
```

## 2) View Task Mapping (tasks_back.json / tasks_gameplay.json)

### GM-0110 (from `.taskmaster\tasks\tasks_gameplay.json`)
- taskmaster_id: `10`
- layer: `core`  priority: `P1`  status: `pending`
- adr_refs: `['ADR-0011', 'ADR-0018', 'ADR-0021', 'ADR-0024']`
- chapter_refs: `['CH01', 'CH06', 'CH07', 'CH10']`
- overlay_refs: `['docs/architecture/overlays/PRD-rouge-manager/08/_index.md', 'docs/architecture/overlays/PRD-rouge-manager/08/08-Feature-Slice-Minimum-Playable-Loop.md', 'docs/architecture/overlays/PRD-rouge-manager/08/08-Contracts-Rouge-Run-Events.md', 'docs/architecture/overlays/PRD-rouge-manager/08/08-Contracts-Security.md', 'docs/architecture/overlays/PRD-rouge-manager/08/08-Contracts-Quality-Metrics.md', 'docs/architecture/overlays/PRD-rouge-manager/08/ACCEPTANCE_CHECKLIST.md']`
- contractRefs(events): `['core.run.started', 'core.map.generated']`
- test_refs: `['Game.Core.Tests/Domain/RngServiceTests.cs', 'Game.Core.Tests/Tasks/Task10AcceptanceTests.cs', 'Game.Core.Tests/Services/RngServiceTests.cs', 'Game.Core.Tests/State/GameStateRunSeedTests.cs']`

## 3) Serena Step 1: find_symbol (RngService/IRngService/GameState/RunSeed)

- `RngService` and `IRngService` are not present in `Game.Core` yet (expected to be created for Task10).
- Existing related symbols found (implementation context):
  - `GameState` in `Game.Core/Domain/GameModels.cs`
  - `RunSeed` in `Game.Core/Contracts/Rouge/Run/RunGameStateSnapshot.cs` and `Game.Core/Contracts/Rouge/Run/RunStarted.cs`

## 4) Serena Step 2: search_for_pattern (existing interfaces / contracts)

- Found key existing interfaces (pure C#):
  - `Game.Core/Services/EventBus.cs`: `IEventBus` + `InMemoryEventBus`
  - `Game.Core/Ports/*`: multiple port interfaces (IDataStore/ILogger/IResourceLoader/ITime/...)

## 5) Serena Step 3: find_symbol (event contracts, ADR-0004 alignment)

- Existing event contracts (CloudEvents type strings):
  - `RunStarted.EventType = "core.run.started"`
  - `MapGenerated.EventType = "core.map.generated"`

### DomainEvent
`Game.Core\Contracts\DomainEvent.cs`
```csharp
using System;

namespace Game.Core.Contracts;

/// <summary>
/// CloudEvents-like event envelope used by the in-process event bus.
/// </summary>
/// <remarks>
/// Baseline follows ADR-0004 (type/source/id/specversion). The payload is stored as JSON text to keep
/// this contract engine-agnostic and testable in pure .NET without Godot dependencies.
/// </remarks>
public sealed record DomainEvent(
    string Type,
    string Source,
    string DataJson,
    DateTimeOffset Timestamp,
    string Id,
    string SpecVersion = "1.0",
    string DataContentType = "application/json"
);
```

### EventBus
`Game.Core\Services\EventBus.cs`
```csharp
using Game.Core.Contracts;

namespace Game.Core.Services;

public interface IEventBus
{
    Task PublishAsync(DomainEvent evt);
    IDisposable Subscribe(Func<DomainEvent, Task> handler);
}

public class InMemoryEventBus : IEventBus
{
    private readonly List<Func<DomainEvent, Task>> _handlers = new();
    private readonly object _gate = new();
    private static readonly object AuditGate = new();
    private readonly string? _auditLogRoot;

    public InMemoryEventBus(string? auditLogRoot = null)
    {
        _auditLogRoot = auditLogRoot;
    }

    public Task PublishAsync(DomainEvent evt)
    {
        List<Func<DomainEvent, Task>> snapshot;
        lock (_gate) snapshot = _handlers.ToList();
        return Task.WhenAll(snapshot.Select(h => SafeInvoke(h, evt)));
    }

    private async Task SafeInvoke(Func<DomainEvent, Task> h, DomainEvent evt)
    {
        try { await h(evt); }
        catch (Exception ex)
        {
            AuditHandlerException(evt, h, ex);
        }
    }

    private void AuditHandlerException(DomainEvent evt, Func<DomainEvent, Task> handler, Exception ex)
    {
        try
        {
            var date = DateTime.UtcNow.ToString("yyyy-MM-dd");
            var root = ResolveAuditRoot(date);
            System.IO.Directory.CreateDirectory(root);

            var path = System.IO.Path.Combine(root, "security-audit.jsonl");

            string handlerName;
            try
            {
                var decl = handler.Method.DeclaringType?.FullName ?? "<unknown>";
                handlerName = $"{decl}.{handler.Method.Name}";
            }
            catch { handlerName = "<unknown>"; }

            var obj = new System.Collections.Generic.Dictionary<string, object?>
            {
                ["ts"] = DateTime.UtcNow.ToString("o"),
                ["action"] = "eventbus.handler.exception",
                ["reason"] = $"{ex.GetType().FullName}: {Truncate(ex.Message, 512)}",
                ["target"] = evt.Type,
                ["caller"] = Environment.UserName,
                ["event_source"] = evt.Source,
                ["event_id"] = evt.Id,
                ["handler"] = handlerName,
                ["exception_type"] = ex.GetType().FullName,
                ["exception_message"] = Truncate(ex.Message, 4096),
                ["stack"] = Truncate(ex.StackTrace ?? string.Empty, 16384),
            };

            var json = System.Text.Json.JsonSerializer.Serialize(obj);
            lock (AuditGate) System.IO.File.AppendAllText(path, json + Environment.NewLine);
        }
        catch
        {
            // ignore audit failures; do not break gameplay
        }
    }

    private string ResolveAuditRoot(string date)
    {
        var root = _auditLogRoot;
        if (string.IsNullOrWhiteSpace(root))
        {
            root = Environment.GetEnvironmentVariable("AUDIT_LOG_ROOT");
        }

        if (!string.IsNullOrWhiteSpace(root))
        {
            if (System.IO.Path.IsPathRooted(root)) return root;
            var repo = TryFindRepoRoot();
            return string.IsNullOrWhiteSpace(repo) ? root : System.IO.Path.Combine(repo, root);
        }

        var repoRoot = TryFindRepoRoot();
        return string.IsNullOrWhiteSpace(repoRoot)
            ? System.IO.Path.Combine("logs", "ci", date)
            : System.IO.Path.Combine(repoRoot, "logs", "ci", date);
    }

    private static string? TryFindRepoRoot()
    {
        try
        {
            var dir = new System.IO.DirectoryInfo(AppContext.BaseDirectory);
            for (int i = 0; i < 24 && dir != null; i++, dir = dir.Parent)
            {
                var full = dir.FullName;
                if (System.IO.File.Exists(System.IO.Path.Combine(full, "project.godot"))) return full;
                if (System.IO.File.Exists(System.IO.Path.Combine(full, "Rouge.sln"))) return full;
                if (System.IO.Directory.Exists(System.IO.Path.Combine(full, ".git"))) return full;
            }
        }
        catch
        {
            // ignore repo root discovery failures
        }
        return null;
    }
```

### RunStarted
`Game.Core\Contracts\Rouge\Run\RunStarted.cs`
```csharp
namespace Game.Core.Contracts.Rouge.Run;

/// <summary>
/// Domain event: core.run.started
/// Description: Emitted when a new run is initialized and starts.
/// </summary>
/// <remarks>
/// Follows ADR-0004 event contracts for the domain. Contract location per ADR-0020.
/// </remarks>
public sealed record RunStarted(
    string RunId,
    int RunSeed,
    PartySnapshot Party,
    DateTimeOffset StartedAt
)
{
    public const string EventType = "core.run.started";
}
```

### MapGenerated
`Game.Core\Contracts\Rouge\Map\MapGenerated.cs`
```csharp
namespace Game.Core.Contracts.Rouge.Map;

/// <summary>
/// Domain event: core.map.generated
/// Description: Emitted when the run map is generated and ready.
/// </summary>
/// <remarks>
/// Follows ADR-0004 event contracts for the domain. Contract location per ADR-0020.
/// </remarks>
public sealed record MapGenerated(
    string RunId,
    string MapId,
    int NodeCount,
    int Depth,
    DateTimeOffset GeneratedAt
)
{
    public const string EventType = "core.map.generated";
}
```

## 6) Serena Step 4: find_referencing_symbols (how modules currently use contracts)

- Current codebase appears to have limited wiring usage:
  - `InMemoryEventBus : IEventBus` exists, but other references to `IEventBus`/events may be minimal right now.
  - Many `Game.Core/Ports/*` interfaces exist but are not widely referenced yet (early scaffolding).

## 7) Task10 Implementation Implications

- Prefer mirroring the existing `EventBus.cs` pattern: define `IRngService` + `RngService` in `Game.Core/Services/RngService.cs`.
- Use only BCL (`System.Random`) in Core; do not use `Godot.GD.Rand*` in Core.
- `RunSeed` already exists in Contracts (`RunGameStateSnapshot`, `RunStarted`); align naming and flow: `GameState`/`RunManager` should own seed and call `IRngService.SetSeed(runSeed)`.
- Keep event type strings as-is (`core.run.started`, `core.map.generated`); do not introduce `core.rouge.*` drift.

## 8) Suggested Serena Keywords for follow-up (when implementing Task10)

- `RngService`, `IRngService`, `SetSeed`, `Shuffle`, `PickRandom`
- `System.Random`, `Random.Shared` (check if anyone used it directly)
- `GD.Rand`, `GD.Randf`, `GD.Randi` (should stay out of Core)
- `RunSeed`, `RunStarted`, `MapGenerated`, `DomainEvent`, `IEventBus`

## 9) Notes / Potential Drift (not part of Task10 but high risk)

- `Game.Core/State/SaveData.cs` contains `StorageKey: "guild-manager-game"` (likely semantic leftover; consider renaming to rouge later under a dedicated task).
