# ADR-0030: 错误处理口径（Exceptions vs Try*/Result vs Fail-Fast）

- Status: Accepted
- Context: 玩法骨干（回合推进/结算/购买/存档）与 Godot 运行时 Glue 之间存在多层边界。若错误处理口径不统一，会出现：同类错误有时 throw、有时返回 false；异常被吞导致 silent failure；或“可恢复错误”被 fail-fast 直接炸掉可玩度。需要一套可执行的口径，让测试与验收能稳定对齐。

## Decision

### 1) Core（Game.Core）错误分类与推荐处理

1. **输入/契约违例（调用方 bug）**
   - 示例：空字符串 id、负数索引、非法 multiplier
   - 处理：抛出 `ArgumentException` / `ArgumentOutOfRangeException`
   - 原则：尽早失败，携带参数名与上下文，便于定位。

2. **可预期的业务拒绝（规则不满足）**
   - 示例：资金不足导致购买失败；背包已满导致拾取失败；本局已结束/角色已死亡
   - 处理：使用 `Try*` 返回 `false`（或将来引入 Result 类型时返回可判定的 Result）
   - 原则：不把正常玩法分支当异常；调用方应显式处理 false 分支并决定 UI/事件反馈。

3. **状态损坏/不变式破坏（数据结构已不可信）**
   - 示例：同一物品被重复入库；资源守恒断言失败；存档快照出现自相矛盾字段
   - 处理：抛出 `InvalidOperationException`（fail-fast）
   - 原则：继续运行会导致更大范围的语义漂移；必须让门禁尽快暴露并阻止继续推进。

4. **端口/IO/外部依赖失败（可恢复）**
   - 示例：读取 user:// 配置失败、DB 打开失败、资源缺失
   - 处理：优先以“返回 false/空值 + 可观测错误”表达；必要时在上层 Glue/UI 层显示可恢复提示。
   - 原则：单机可玩度优先；失败必须可见（日志/审计/错误上报），但不应 silent。

### 2) Adapters / Scenes（Godot 运行时）处理口径

- **UI 交互不得直接让进程崩溃**：对用户触发的行为，必须保证“失败可恢复”（保持 UI 可交互或回到菜单）。
- **Glue 必须把启动失败显式化**：例如主菜单 Start 失败需要发出可观测的失败表征（事件/信号/状态文本），避免“菜单消失但游戏未开始”的死路。
- **审计/可观测必须 best-effort**：失败仅影响取证，不影响玩法结果（与 ADR-0003/0019/0026 对齐）。

### 3) 测试与验收要求（最小集）

- 针对每个“可恢复失败”路径，至少一条回归用例验证：
  - 调用方不会进入死路（仍可交互/可回菜单）
  - 失败原因可观测（事件、状态文本或日志证据）
- 针对每个“状态损坏”路径，至少一条用例验证 fail-fast（抛 `InvalidOperationException`）。

## Consequences

- 正向：把“异常/返回值/可恢复”统一口径，减少语义漂移；让验收条款能与测试一一对应。
- 代价：部分 API 需要调整为 `Try*` 或补充失败事件/状态；Glue/UI 需要承担“失败可恢复”的责任。

## References

- ADR-0003: 可观测性与 Release Health
- ADR-0019: Godot 安全基线（审计与落盘）
- ADR-0026: 事件发布失败策略
- ADR-0031: Core 线程模型与跨线程边界
